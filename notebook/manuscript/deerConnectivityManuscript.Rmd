---
title: "Tick Deer Rodent Connectivity Methods"
author1: "---*"
author2: "---**"
affiliation1: "---"
affiliation2: "---"
corresponding1: "---"
corresponding2: "---"
date: "`r Sys.Date()`"
output:
  bookdown::pdf_document2:
    template: main.tex
    keep_tex: true
    highlight: monochrome
    fig_caption: true
    dev: pdf
    extra_dependencies: ["float"]
  bookdown::html_document2:
    theme: yeti
    highlight: monochrome
    fig_caption: true
link-citations: yes
linkcolor: gray
bibliography: [deerMovement_refs.bib, packages_refs.bib, packagesRstudio_refs.bib]
csl: peerj.csl
editor_options: 
  markdown: 
    wrap: sentence
abstract: abstract text
keywords: deer, rodent, connectivity
---

# Methods

``` {r librariesInputs, echo=FALSE, message=FALSE, warnings=FALSE, include=FALSE}
library(here, quietly = TRUE, verbose = FALSE)
library(dplyr, quietly = TRUE, verbose = FALSE)
library(stringr, quietly = TRUE, verbose = FALSE)

inputList <- readRDS(file = here::here("data", "inputList.rds"))

longestAxisSummary <- read.csv(file = here::here("tables", "longestAxisSummary.csv"))
longestAxisText <- mean(as.numeric(longestAxisSummary$longestAxisRange_m))/2

# targets::tar_load("tar_occData_fallow", store = here::here("_targets"))
# targets::tar_load("tar_occData_rodent", store = here::here("_targets"))

### need code to extract numbers of individuals used in SDMS

```

## Estimating Preference and Probability of Occurrence

For the Roe Deer we made use of previously conducted analysis on their movements that aimed to determine their preference for various land use types, as well as how their movements are altered when within them <CITE PREPRINT MOVEMENT PAPER WHEN READY>.
We took the coefficients of the population level Poisson habitat preference model as a basis to estimate landscape level Roe Deer functional connectivity.

For Fallow Deer and Rodents, we lacked sufficient movement data to undertake the a similar procedure.
Instead we followed the workflow outlined by @prima_comprehensive_2024, using species distribution modelling to generate reasonable estimations of landscape resistance and then applying a circuit-theory approach to determine how interconnected selected woodland patches were [@mcrae_using_2008; @mcrae_conserving_2016].

We collated occurrence data from GBIF and NBN Atlas [@gbif_gbiforg_2025; @nbn_trust_national_2025] for the Fallow Deer and Rodents, using searches from "*Dama dama*", "*Myodes glareolus*", "*Apodemus flavicollis*", "*Apodemus sylvaticus*", "*Sciurus carolinensis*", and "*Sciurus vulgaris*" [@gbif_fallow_2025; @gbif_rodent_2025].
<!-- NBN has specific DOIs to add from the README files that came with the download -->
We downloaded all records within the UK, for all species.
We filtered the records as to only include those made via human observations, were recorded to sub-25m accuracy, and had verified species identities.
Once filtered we used CoordinateCleaner <CITE> to eliminate records that likely contained location errors on a species-by-species basis.
Namely we removed records within 10km of a capital, within 1km of a country centroid, had identical decimal latitude and longitudes, had zero in either latitude or longitude, or were identified as outliers. 
We used the quantile method of identifying outliers, removing those records beyond 5 times the interquartile range of minimum distances to the next neighbour.
Finally, we thinned the both the Fallow Deer and Rodent data so that no occurrence shared a raster cell with another occurrence.
This process resulted in __ occurrence locations of Fallow Deer and ___ for rodents (__ *Myodes glareolus*; __ *Apodemus flavicollis*; __ *Apodemus sylvaticus*; __ *Sciurus carolinensis*; __ *Sciurus vulgaris*).

We generated a number pseudo-absences data points for both target taxa equal to three times the number of true-occurrences available; we repeated this process 10 <!-- ensure it matches with code --> times allowing for multiple model fits <!-- biomod2 has reccommendations regarding these numbers: https://biomodhub.github.io/biomod2/articles/vignette_pseudoAbsences.html-->.
In the case of Fallow Deer, we limited the area pseudo-absences generated within to 6.2km of a known Fallow Deer occurrence.
As Fallow Deer have not uniformly spread across the UK, this limit excluded areas where they have not, as of yet, had the opportunity to colonise.
For rodents we limited the pseudo-absences to Great Britain (minus Shetland and other outlying islands groups such as St. Kilda).
We weighted the pseudo-absences using a bias layer to mitigate the impacts of the sampling biases associated with the true-occurrence data.
For our bias layer, we used the human footprint index [@mu_annual_2021; @mu_global_2022] that combines a variety of human activities and land conversions into a single metric, and could serve as a proxy for the likelihood of observing our target species.

We used the biomod2 package to manage species distribution modelling <CITE>.
We fitted a variety of models: Artificial Neural Network, Boosted Regression Trees, Generalized Linear Model, and Random Forest. 
We intended to run Maximum Entropy and eXtreme Gradient Boosting Training, but the inclusion of categoric variables precluded their use.
<!-- We used block cross validation, balanced based on environmental covariates, to evaluate model performance <CITE>. NO LONGER - SWAPPED TO STRATIFIED -->
We used stratified cross validation to evaluate model performance, as we were not priorisitisng model transferability [@Muscarella2014].
We balanced stratification based on known occurrences both in x and y dimensions.
We elected to use True Skill Statistic (TSS) as our primary metric of model performance [@shabani_assessing_2018; @allouche_assessing_2006].
Once all models had been complete, we compiled all models into an ensemble model ready for projection to our target landscapes.
We included all models that obtained TSS scores of over 0.25, and weighted models proportionately to their TSS score.
Once the TSS weighted mean ensemble model had been created, we used it to project the probability of occurrence to the Aberdeenshire and Wessex landscapes.

## Translating Preferences into Connectivity

For Roe Deer, once we had estimates of selection and effect for all the environmental aspects of interest, we spatially mapped those estimated covariates back onto the landscape, resulting in a map of conductance (Fig. \@ref:(figconductancePlot)).
This process took the form of generating a model matrix based on all environmental covariates at each cell in the overall landscape raster and using the fitted Poisson model coefficients to calculate predicted deer use for each cell.
For roads we rasterised the road polyline data and used the road crossing coefficient to create a conductance value for the road cells.
For the covariates that involved movement interactions, we used the mean step and turn angle in calculations of predicted use.
We replaced any areas with 0 conductance with 1e-12 to avoid any dead-ends or any absolute barriers.
For we ignored the uncertainty surrounding the selection estimates, instead relying on just the point estimates for the resistance mapping.
<!-- invert logit to standardise them and flip them to movement ease -->

For the Fallow Deer and Rodents the underlying conductance layer was generated from the final ensemble species distribution model.
In the case of the Fallow Deer we have sufficient data to parametrise the road resistance based on the results of a Fallow Deer Poisson model. 
This modelling process mirrored the procedure undertaken for Roe Deer except only examined hte likelihood of crossing a road.
We altered the resistance of the cells that corresponded to the presence of a road in the same way as described for the Roe Deer, using values draw from the Poisson model.
We did not have comparable road crossing data for the rodents, meaning that their conductance raster equalled one describing probability of occurrence. 

```{r conductancePlot, echo=FALSE, out.width='75%', fig.align="centre", fig.pos = "h", fig.cap="Conductance map of Aberdeen landscape developed from the coefficients of the Poisson habitat selection model. Higher values indicate easier movement for Roe Deer. Axis are m in British National Grid coordinate system."}
knitr::include_graphics(here::here("figures", "resistanceConductanceMap_Pois_Aberdeenshire.png"))
```

<!-- Random Shortest Paths -->
For Roe Deer, we used random shortest paths, that consists of generating random walks between locations, to simulate potential connectivity across the landscapes based on the above described conductance/resistance raster.
This method was used to show the connectivity of areas used by reindeer, and offers a mechanism for calibrating the connectivity maps to both the habitat selection and movement path characteristics [@panzacchi_predicting_2016].

We used habitat patches as the sources of our random locations.
We limited calculations of random shortest paths to pairs of patches that existed within 750 m of each other.
We selected 750 m as that represented the mean longest axis of the 99% HR estimate of the deer (excluding outlying non-contiguous portions of the area polygons).
For every pairing, we generated `r inputList$repeatsPerPair[1]` start and end locations in each patch and ran random shortest paths between these locations.
We repeated this for every pairing of patches.
<!-- excluded patches smaller than the smallest selected patch area -->
We elected not to generate start or end points in patches less than 0.5ha in areas, following <CITE>. 
This was due to these patches being unlikely to host deer populations and the reduction in origin patches aided computational costs.
<!-- double check patch numbers if wessex is updated -->
The 0.5 ha threshold meant that 3415 Aberdeen patches and 7564 Wessex patches were included in the generation of random shortest paths, thereby necessitating optimisations for the sake of compute time.
Instead of considering the entire landscape when calculating the paths, the vast majority of which would not play a role between two neighbouring patches, we cropped the conductance raster to only include at area surrounding the randomly selected start and end points.
This cropped area was `r inputList$setCropArea`m in all directions from the start and end points; where start and end points exceeded four times `r inputList$setCropArea`m apart from each other we extended the cropped area to half the distance between the two points in all directions.
This was required to avoid prohibitively computational intensive paths (i.e., those that encompassed nearly the entire landscape) caused by patches with large areas.
A further optimisation was required to run the random shortest paths efficiently, we limited the distance between start and end location to four times the mean longest axis of the 99% HR estimate (4 times `r round(longestAxisText, digits = 0)` m).
This adaptive cropping allowed for much faster calculation, while retaining sufficient raster landscape for circuitous paths to be estimated.

Once every walk was complete, the resulting rasters describing the likelihood of a deer crossing a cell are complied into a single landscape raster describing connectivity and standardised between 0 and 1 (where 0 is low connectivity and 1 is high connectivity).

A key consideration in these walks is how random the paths are.
We elected to run walks at `r length(inputList$theta)` different levels of randomness (theta; with 1 being close to a least cost path, and `r inputList$theta[length(inputList$theta)]` being the most random and diffuse walks; Fig. \@ref(fig:thetaPlot)).

```{r thetaPlot, echo=FALSE, out.width='100%', fig.align="centre", fig.pos = "h", fig.cap="The connectivity maps under differing levels of theta (randomness) in the random shortest paths between patches. The colour scale is squarerooted to better differeniate low conenctivity areas. Axis are m in British National Grid coordinate system."}
knitr::include_graphics(here::here("figures", "thetaMaps_Pois.png"))
```

To determine what level of randomness best reflected the realised movements of the deer, we compared the resulting connectivity maps to dynamic Brownian Bridge Movement Models [@Kranstauber2012; @move].
Dynamic Brownian Bridge Movement Models run a series of random walks between defined start and end points, from the summation of these walks you can extract a rasterised occurrence distribution.
Critically the dBBMM walks are calibrated to the movement capacity of the animal through rolling window (i.e., a number of data points) that summarises the movement rate during that time.
Additionally within that window, a margin (a subset of data points) is used to detect any sudden changes in movement capacity that may be reflect of behavioural/movement mode changes.
Therefore the dBBMMs provide a estimate of how diffuse the movements could be between known locations.
We ran dBBMMs for all roe deer with a window size of `r inputList$windowSize` and a margin of `r inputList$marginSize`, that provided estimates of motion variance on roughly a weekly sliding window with the allowance of sudden motion variance changes day to day (margin).
We compared the dBBMMs to the connectivity maps constructed with varying levels of randomness, and used mean squared error to determine which level of randomness best fit the movement data.
We used the connectivity map created using that theta value for all subsequent analysis.
<!-- Circuitscape -->
<!-- The second method we used to create connectivity maps was circuitscape. -->
<!-- Explainer why circuitscape is good to use in two sentences here -->
<!-- Circuitscape involve treating the landscape as wired circuit with differing levels of resistance between nodes (inputs and grounds). -->
<!-- In much the same way as the random shortest paths, we selected pairs of nodes (habitat patches) within ___ m to run circuitscape between. -->

We examined whether the connectivity maps generated matched the observed movements of roe deer using a logistic regression.
The model was supplied with the known locations of deer as well as `r inputList$nAvailable` randomly generated points per known deer location across the landscape, all of which had associated connectivity values.
We formulated the model to predict whether a point was used or random based on the connectivity values, and we included a random effect for deer ID.
The expectation was that the model coefficients would indicate that deer locations were positively associated with higher connectivity values.

For the Fallow Deer and Rodents, we followed @prima_comprehensive_2024 and used Omniscape.jl [@landau_omniscapejl_2021], built on Circuitscape.jl [@mcrae_conserving_2016; @anantharaman_circuitscape_2020; @hall_circuitscape_2021], to generate a map of landscape connectivity in both landscapes [@mcrae_using_2008].
To aid with computation costs, we selected a block size of 31 for the Fallow Deer, and 15 for the Rodents<!-- draw from inputList ideally -->.
We ensured that the block size was less than one-tenth of the search radius to minimise grid artifacting [@phillips_comparison_2021; @prima_comprehensive_2024].
We also varied the search radius between the groups, as each has different movement/dispersal abilities.
In both instances we based our search radius on previously recorded estimates of home range size, based heavily on the data provide by the home range database [@broekman_homerange_2023; @broekman_homerange_2022].
In both case we filtered the home range data to species/group and calculated a mean home range area.
For the Fallow Deer their mean home range suggested a search radius of 1500<!-- draw from inputList ideally -->; whereas for Rodents a search radius of 150<!-- draw from inputList ideally --> was chosen.
For both groups we used the previously denoted patches as sources/nodes (all with the same strength).

<!-- ## Projecting to Wessex -->
<!-- We elected to retain the Wessex Roe Deer data for model validation, as compared to Aberdeen the tracking was conducted for a shorter period with fewer individuals. -->
<!-- We compared the known locations of deer to the connectivity maps to test their ability to predict deer movements. -->
<!-- precision recall?? might not be possible as no binary -->
<!-- Root Mean Squared Error (RSME) -->
<!-- logistic regression -->
\clearpage

# Results

## Connectivity maps

(Fig. \@ref(fig:poisConnect))

```{r poisConnect, echo=FALSE, out.width='100%', fig.height=5, fig.width=3, fig.align="centre", fig.pos = "h", fig.cap="The resulting connectivity map for the Aberdeen landscape displayed on a cell by cell level and summarised by patch. Selected patches are highlighted in orange. Lower panel shows how the selected (tick sampled) patches relate to the overall distribution of patch connectivity values. N.b. connectivity scale is square-rooted. Axis are m in British National Grid coordinate system."}
knitr::include_graphics(here::here("figures", "patchConnectivity_Pois_Aberdeenshire.png"))
```

(Fig. \@ref(fig:fallowWessexConnect))

```{r fallowWessexConnect, echo=FALSE, out.width='75%', fig.height=5, fig.width=3, fig.align="centre", fig.pos = "h", fig.cap="Fallow deer, Wessex. Values > 1 are channelised flow. Values ~ 1 are diffuse flow matching general flow potential. Values < 1 are impeded flow"}
knitr::include_graphics(here::here("figures", "fallow_NA_omniscapeOutputs_plot.png"))
```

(Fig. \@ref(fig:rodentWessexConnect))

```{r rodentWessexConnect, echo=FALSE, out.width='75%', fig.height=5, fig.width=3, fig.align="centre", fig.pos = "h", fig.cap="rodent, Wessex"}
knitr::include_graphics(here::here("figures", "rodent_wessex_omniscapeOutputs_plot.png"))
```

(Fig. \@ref(fig:rodentAberdeenConnect))

```{r rodentAberdeenConnect, echo=FALSE, out.width='75%', fig.height=5, fig.width=3, fig.align="centre", fig.pos = "h", fig.cap="rodent, Aberdeen"}
knitr::include_graphics(here::here("figures", "rodent_Aberdeen_omniscapeOutputs_plot.png"))
```

## Roe Deer Connectivity Validation

(Fig. \@ref(fig:densityOfConnectivityAberdeen))
(Fig. \@ref(fig:densityOfConnectivityWessex))
(Fig. \@ref(fig:strucFuncComparison))

```{r densityOfConnectivityAberdeen, echo=FALSE, out.width='100%', fig.height=5, fig.width=3, fig.align="centre", fig.pos = "h", fig.cap="Distribution of connectivity values at known deer locations and randomly generated locations across the Aberdeen landscape, as well as random locations generated within the 95% home range. Lower caption describes the results of the logisitic regression testing whether connectivity can predict whether the location was random or a known deer location."}
knitr::include_graphics(here::here("figures", "densityOfConnectivity_Aberdeen.png"))
```

```{r densityOfConnectivityWessex, echo=FALSE, out.width='100%', fig.height=5, fig.width=3, fig.align="centre", fig.pos = "h", fig.cap="Distribution of connectivity values at known deer locations and randomly generated locations across the Wessex landscape, as well as random locations generated within the 95% home range. Lower caption describes the results of the logisitic regression testing whether connectivity can predict whether the location was random or a known deer location."}
knitr::include_graphics(here::here("figures", "densityOfConnectivity_Wessex.png"))
```

```{r strucFuncComparison, echo=FALSE, out.width='100%', fig.height=5, fig.width=3, fig.align="centre", fig.pos = "h", fig.cap="A comparison between the mean connectivity values derived from deer movement data and the structural metrics of connectivity on a patch by patch basis. Outlying patch areas are replaced with labels indicating their size in square kilometres. Boxes on the right describe the linear relationship between the two variables."}
knitr::include_graphics(here::here("figures", "funcStrucConnectPlot.png"))
```

\clearpage

# Acknowledgements

## Software availablity

```{r packageText, child="packageParagraph.txt", eval=TRUE}

```

<!-- CIRCUITSCAPE -->
<!-- circuitscape, juliacall -->

## Data availabilty

## Author Contributions

# Supplementary Material

```{r fallowOccurence, echo=FALSE, out.width='100%', fig.height=5, fig.width=3, fig.align="centre", fig.pos = "h", fig.cap="fallow deer, occurrence data"}
knitr::include_graphics(here::here("figures", "fallow_occurrenceData_plot.png"))
```

```{r rodentOccurence, echo=FALSE, out.width='100%', fig.height=5, fig.width=3, fig.align="centre", fig.pos = "h", fig.cap="rodent, occurrence data"}
knitr::include_graphics(here::here("figures", "rodent_occurrenceData_plot.png"))
```

```{r fallowEnsResponseDistance, echo=FALSE, out.width='100%', fig.height=5, fig.width=3, fig.align="centre", fig.pos = "h", fig.cap="fallow, ensemble response, green highlight values that exist in Wessex environment"}
knitr::include_graphics(here::here("figures", "fallow_responseDistanceEnsemble.png"))
```

```{r rodentEnsResponseDistance, echo=FALSE, out.width='100%', fig.height=5, fig.width=3, fig.align="centre", fig.pos = "h", fig.cap="rodent, ensemble response, green highlight values that exist in Wessex environment"}
knitr::include_graphics(here::here("figures", "rodent_responseDistanceEnsemble.png"))
```

```{r fallowEnsResponseBinary, echo=FALSE, out.width='100%', fig.height=5, fig.width=3, fig.align="centre", fig.pos = "h", fig.cap="fallow, ensemble binary responses"}
knitr::include_graphics(here::here("figures", "fallow_responseBinaryEnsemble.png"))
```

```{r rodentEnsResponseBinary, echo=FALSE, out.width='100%', fig.height=5, fig.width=3, fig.align="centre", fig.pos = "h", fig.cap="rodent, ensemble binary responses"}
knitr::include_graphics(here::here("figures", "rodent_responseBinaryEnsemble.png"))
```

```{r fallowEnsVarImp, echo=FALSE, out.width='100%', fig.height=5, fig.width=3, fig.align="centre", fig.pos = "h", fig.cap="fallow, ensemble var importance"}
knitr::include_graphics(here::here("figures", "fallow_varImportanceEnsemble.png"))
```

```{r rodentEnsVarImp, echo=FALSE, out.width='100%', fig.height=5, fig.width=3, fig.align="centre", fig.pos = "h", fig.cap="rodent, ensemble var importance"}
knitr::include_graphics(here::here("figures", "rodent_varImportanceEnsemble.png"))
```

\clearpage

# References
